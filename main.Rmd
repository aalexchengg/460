
---
title: "36-460/660 Final Project Main"
author: "Alex Cheng, Melody Wang, Liz Chu, Kevin Ren"
date: "April 23rd, 2024"
output:
  pdf_document:
    toc: yes
  html_document:
    code_folding: show
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: inline
---


# Data Preproccessing 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("nflfastR")
library("ggplot2")
library(tidyverse)
```


```{r cars}
df <- nflfastR::load_pbp()
```

```{r}
# this takes 14 seconds on my shitty laptop
df = clean_pbp(df)
```
```{r}
# CLEAN DATA
# remove all plays that weren't rushes or passes (this means punts, kickoffs, special teams plays, aborted plays, qb spikes, etc.)
df$success = ifelse(df$down >= 3 & df$ydstogo > df$yards_gained, 0, df$success)
cleandf = df %>% filter(play_type == "run" | play_type == "pass") %>% filter(penalty == 0) %>% filter(success == 1)
# remove all plays where a penalty occured - we only want normal plays
# set third downs that didnt get a first down as unsuccessful
# 3 1/2 we can think of other successes but this is the easiest one so far
# remove all unsuccessful plays
```


```{r}
tmp_df = filter(df, game_id == "2023_01_ARI_WAS")
tmp_df$game_seconds_remaining
head(tmp_df)
# for all plays:
# find the game the play took place in
# find the play before this one, that took place closest to it
# get the type of play this one was
# we can group by prev_play for conditional visualization
```
```{r}
library(dplyr)
playData <- df %>%
  arrange(game_id, time) %>%
  group_by(game_id) %>%
  group_by(time, .add = TRUE)
playData <- playData[,c("game_id", "time", "play_id", "play_type", "drive")]
```

```{r}
df$drive
```


```{r}
playData = df[,c("game_id", "time", "play_id", "play_type", "drive")]

playData[, "prev_play"] = NA
for (i in 1:nrow(playData)) {
  # if special teams play, note this
  if (is.na(playData[i,]$play_type) | is.na(playData[i,]$drive) | ((playData[i,]$play_type != "run") & (playData[i,]$play_type != "pass"))) {
    playData[i,]$prev_play = "special"
  }
  # if first play of drive, then make prev_play a special token
  else if ((i == 1) | is.na(playData[i-1,]$drive) | (playData[i-1,]$drive != playData[i,]$drive)) {
    playData[i,]$prev_play = "first play"
  }
  # "normal" play
  else {
   playData[i,]$prev_play = playData[i-1,]$play_type
  }
  
}
head(playData, 10)
```